# 任务名称，自定义
name: Bilibili Comment Monitor To Feishu
# 触发规则：每5分钟定时执行 + 手动触发（测试用）
on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

# 执行任务
jobs:
  monitor-bilibili-comment:
    runs-on: ubuntu-latest
    steps:
      # 拉取仓库代码（必须步骤，不能删）
      - name: Checkout code
        uses: actions/checkout@v4

      # 配置Python3.10环境（已删除缓存，解决之前的缓存报错）
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 安装系统编译依赖 + 先装预编译pyyaml + 再装其他Python依赖（核心修复）
      - name: Install all dependencies
        run: |
          # 更新系统源 + 安装编译基础依赖
          sudo apt-get update -y && sudo apt-get install -y gcc python3-dev
          # 升级pip，避免低版本pip不支持预编译包
          python -m pip install --upgrade pip
          # 关键：安装预编译版pyyaml，跳过本地编译
          pip install pyyaml --only-binary=:all:
          # 安装B站API和请求库，此时pyyaml已存在，不会再编译
          pip install bilibili_api requests

      # 执行监控脚本（传递GitHub Secrets的配置）
      - name: Run monitor script
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          FEISHU_SECRET: ${{ secrets.FEISHU_SECRET }}
          BILIBILI_UID: ${{ secrets.BILIBILI_UID }}
        run: python monitor.py
