# 任务名称，可自定义
name: Bilibili Comment Monitor To Feishu
# 触发规则：定时执行+手动触发（方便测试）
on:
  schedule:
    # cron表达式，默认每5分钟执行一次（可改，格式：分 时 日 月 周）
    - cron: "*/5 * * * *"
  workflow_dispatch:  # 手动触发按钮，测试用

# 执行任务
jobs:
  monitor-bilibili-comment:
    # 运行环境：Ubuntu最新版
    runs-on: ubuntu-latest
    # 任务步骤
    steps:
      # 拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 配置Python环境（3.10版本，适配B站API库）
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 安装脚本所需依赖（B站API+请求库）
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bilibili_api requests

      # 执行监控脚本（核心步骤）
      - name: Run monitor script
        env:
          # 把GitHub Secrets的变量传给脚本，名称必须和Secrets一致
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          FEISHU_SECRET: ${{ secrets.FEISHU_SECRET }}
          BILIBILI_UID: ${{ secrets.BILIBILI_UID }}
        run: python monitor.py

      # 保存评论ID文件（防单次任务重复推送）
      - name: Save last comment ID
        uses: actions/upload-artifact@v4
        with:
          name: last-rpid
          path: last_rpid.txt
